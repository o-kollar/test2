<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Payme & QR Generátor</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Vue.js 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <!-- QRCode.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  
  <!-- bysquare library -->
  <script type="module">
    import { encode } from "https://esm.sh/bysquare@latest";
    window.bysquare = { encode };
  </script>

  <style>
    /* System Fonts */
    html { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
    
    /* Hide Scrollbar */
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

    /* Animations */
    .ease-spring { transition-timing-function: cubic-bezier(0.34, 1.3, 0.64, 1); }
    .snap-center { scroll-snap-align: center; }
    .snap-x { scroll-snap-type: x mandatory; }
  </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800 flex items-center justify-center p-4">

  <div id="app" class="w-full max-w-md mx-auto pb-10">
    
    <!-- Header -->
    <header class="flex justify-between items-center mb-6 px-2">
      <h1 class="text-2xl font-bold text-slate-900 tracking-tight">Platba QR</h1>
      <span class="text-xs font-mono text-indigo-400 bg-indigo-50 px-3 py-1 rounded-full">2025</span>
    </header>

    <!-- 1. ADD ACCOUNT FORM -->
    <transition enter-active-class="transition duration-300 ease-out" enter-from-class="transform -translate-y-4 opacity-0" enter-to-class="transform translate-y-0 opacity-100" leave-active-class="transition duration-200 ease-in" leave-from-class="transform translate-y-0 opacity-100" leave-to-class="transform -translate-y-4 opacity-0">
      <div v-if="isAddingProfile" class="mb-6 bg-white p-6 rounded-[2rem] shadow-xl border border-indigo-100 relative z-30">
          <div class="flex justify-between items-center mb-4">
             <h3 class="font-bold text-slate-800 ml-1">Nový Účet</h3>
             <button @click="isAddingProfile = false" class="text-xs text-slate-400 font-bold uppercase hover:text-slate-600 px-2">Zrušiť</button>
          </div>
          <div class="space-y-3">
            <input type="text" v-model="newProfile.name" placeholder="Názov (napr. Firma)" class="w-full bg-slate-50 border-0 rounded-2xl px-5 py-3.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-shadow">
            <input type="text" v-model="newProfile.recipientName" placeholder="Meno príjemcu" class="w-full bg-slate-50 border-0 rounded-2xl px-5 py-3.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-shadow">
            <input type="text" v-model="newProfile.iban" placeholder="IBAN" class="w-full bg-slate-50 border-0 rounded-2xl px-5 py-3.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-shadow">
          </div>
          <button @click="saveProfile" class="w-full mt-5 bg-indigo-600 hover:bg-indigo-700 text-white py-3.5 rounded-full font-bold shadow-lg shadow-indigo-200 transition-all active:scale-95">Uložiť Účet</button>
      </div>
    </transition>

    <!-- 2. MAIN CARD AREA -->
    <div class="relative w-full aspect-[1.586/1] mb-8 z-10">
        
        <!-- A. CAROUSEL -->
        <div 
            class="absolute inset-0 w-full h-full transition-all duration-500 ease-spring"
            :class="isQrVisible ? 'opacity-0 scale-90 pointer-events-none' : 'opacity-100 scale-100 z-20'"
        >
            <div 
                ref="carouselRef"
                class="flex overflow-x-auto snap-x snap-mandatory scrollbar-hide w-full h-full items-center"
            >
                <!-- Profile Cards -->
                <div 
                    v-for="profile in profiles" 
                    :key="profile.name"
                    class="w-full h-full flex-shrink-0 snap-center relative px-0.5" 
                    :data-profile="profile.name"
                >
                    <div class="w-full h-full bg-gradient-to-br from-indigo-600 to-violet-700 rounded-3xl text-white p-7 flex flex-col justify-between shadow-xl shadow-indigo-200 border border-white/10 overflow-hidden relative">
                        <div class="absolute -top-10 -right-10 w-48 h-48 bg-white/10 rounded-full blur-3xl pointer-events-none"></div>
                        
                        <div class="flex justify-between items-start z-10">
                            <div>
                                <p class="text-indigo-200 text-[10px] font-bold tracking-wider uppercase mb-1">Účet</p>
                                <h3 class="text-2xl font-bold truncate max-w-[200px] tracking-tight">{{ profile.name }}</h3>
                            </div>
                            <button @click.stop="deleteProfile(profile.name)" class="text-indigo-200 hover:text-white p-2 hover:bg-white/10 rounded-full transition-colors -mr-2 -mt-2">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                        </div>
                        
                        <div class="z-10">
                            <p class="text-indigo-200 text-[10px] font-bold tracking-wider uppercase mb-1">IBAN</p>
                            <div class="bg-black/20 px-3 py-2 rounded-xl backdrop-blur-sm border border-white/10 inline-block max-w-full">
                                <p class="font-mono text-sm sm:text-base truncate">{{ profile.iban }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add Button -->
                <div class="w-full h-full flex-shrink-0 snap-center px-0.5">
                    <button 
                        @click="isAddingProfile = true"
                        class="w-full h-full rounded-3xl border-2 border-dashed border-slate-300 bg-white hover:bg-slate-50 hover:border-indigo-400 text-slate-400 hover:text-indigo-600 transition flex flex-col items-center justify-center gap-3 group"
                    >
                        <div class="w-14 h-14 rounded-full bg-slate-100 group-hover:bg-indigo-100 flex items-center justify-center transition-colors">
                            <svg class="w-7 h-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                        </div>
                        <span class="font-bold text-sm">Pridať Účet</span>
                    </button>
                </div>
            </div>
            
            <div class="absolute -bottom-6 left-0 w-full flex justify-center gap-2" v-if="profiles.length > 1">
                <div v-for="(p, idx) in profiles" :key="idx" class="h-1.5 rounded-full transition-all duration-300" :class="activeProfileName === p.name ? 'bg-indigo-600 w-4' : 'bg-slate-300 w-1.5'"></div>
                <div class="w-1.5 h-1.5 rounded-full bg-slate-300"></div>
            </div>
        </div>

        <!-- B. QR RESULT -->
        <div 
            class="absolute inset-0 w-full h-full bg-white rounded-3xl border border-slate-200 p-6 flex items-center justify-between shadow-2xl transition-all duration-500 ease-spring"
            :class="isQrVisible ? 'opacity-100 scale-100 z-30 translate-y-0' : 'opacity-0 scale-95 pointer-events-none translate-y-4'"
        >
            <div class="h-full aspect-square bg-white rounded-2xl flex items-center justify-center relative flex-shrink-0">
                <div ref="qrcodeContainer" class="mix-blend-multiply"></div>
            </div>

            <div class="flex-1 pl-5 flex flex-col justify-between items-end text-right h-full py-2">
                <div>
                    <span class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Spolu</span>
                    <p class="text-3xl font-extrabold text-indigo-600 tracking-tighter leading-none">
                        {{ payment.amount ? Number(payment.amount).toFixed(2) : '0.00' }}€
                    </p>
                </div>

                <div class="w-full">
                    <!-- Prominent Payme Button (Solo) -->
                    <button @click="copyPaymeLink" class="w-full py-3 px-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-2xl text-sm font-bold shadow-md shadow-indigo-200 transition-all flex items-center justify-center gap-2 active:scale-95">
                        <span v-if="!paymeLinkCopied">Payme Link</span>
                        <span v-else>Skopírované!</span>
                        <svg v-if="!paymeLinkCopied" class="w-4 h-4 text-indigo-200" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. INPUTS (Redesigned: Same Size) -->
    <div class="space-y-3 px-2 mt-10 transition-all duration-500" :class="isQrVisible ? 'opacity-40 blur-[1px] pointer-events-none' : 'opacity-100'">
        
        <!-- Suma -->
        <div class="h-20 bg-white px-5 rounded-[1.25rem] shadow-sm border border-slate-200 flex flex-col justify-center relative focus-within:border-indigo-500 focus-within:ring-2 focus-within:ring-indigo-500/20 transition-all">
            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-0.5">Suma</label>
            <div class="flex items-center">
                <input type="number" step="0.01" v-model="payment.amount" class="w-full text-xl font-bold text-slate-800 outline-none bg-transparent placeholder-slate-300" placeholder="0.00">
                <span class="text-xl font-bold text-slate-300 ml-2">€</span>
            </div>
        </div>

        <!-- VS -->
        <div class="h-20 bg-white px-5 rounded-[1.25rem] shadow-sm border border-slate-200 flex flex-col justify-center relative focus-within:border-indigo-500 focus-within:ring-2 focus-within:ring-indigo-500/20 transition-all">
            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-0.5">VS</label>
            <input type="text" v-model="payment.vs" maxlength="10" placeholder="----" class="w-full text-xl font-bold text-slate-800 font-mono outline-none bg-transparent placeholder-slate-300">
            <button @click="generateVariableSymbol" class="absolute top-1/2 -translate-y-1/2 right-4 text-slate-300 hover:text-indigo-600 transition p-2 hover:bg-indigo-50 rounded-full mt-1">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
            </button>
        </div>

        <!-- Správa -->
        <div class="h-20 bg-white px-5 rounded-[1.25rem] shadow-sm border border-slate-200 flex flex-col justify-center relative focus-within:border-indigo-500 focus-within:ring-2 focus-within:ring-indigo-500/20 transition-all">
            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-0.5">Správa</label>
            <input type="text" v-model="payment.msg" placeholder="Poznámka..." class="w-full text-lg font-bold text-slate-800 outline-none bg-transparent placeholder-slate-300 truncate">
        </div>
    </div>

    <!-- 4. ACTION BUTTON (Swaps between Generate and Close) -->
    <div class="mt-4 px-1 relative h-16">
        <transition 
          mode="out-in"
          enter-active-class="transition duration-200 ease-out" 
          enter-from-class="transform scale-90 opacity-0" 
          enter-to-class="transform scale-100 opacity-100" 
          leave-active-class="transition duration-150 ease-in" 
          leave-from-class="transform scale-100 opacity-100" 
          leave-to-class="transform scale-90 opacity-0"
        >
            <button 
                v-if="!isQrVisible"
                key="generate"
                @click="generateQRCode" 
                :disabled="!activeProfileName || !payment.amount"
                class="absolute inset-0 w-full h-full rounded-full font-bold text-lg shadow-xl shadow-indigo-200 bg-indigo-600 text-white hover:bg-indigo-700 disabled:bg-slate-300 disabled:shadow-none disabled:cursor-not-allowed z-20"
            >
                Vygenerovať QR kód
            </button>
            
            <button 
                v-else
                key="close"
                @click="closeQr" 
                class="absolute inset-0 w-full h-full rounded-full font-bold text-lg shadow-xl shadow-slate-200 bg-white text-slate-500 hover:bg-slate-50 hover:text-slate-800 border-2 border-slate-200 z-20"
            >
                Zatvoriť
            </button>
        </transition>
    </div>

  </div>

  <script type="module">
    const { createApp, ref, onMounted, watch, nextTick } = Vue;

    createApp({
      setup() {
        // Elements
        const carouselRef = ref(null);
        const qrcodeContainer = ref(null);
        
        // App State
        const isAddingProfile = ref(false);
        const isQrVisible = ref(false);
        const paymeLinkCopied = ref(false);
        const activeProfileName = ref('');
        const profiles = ref([]);
        
        // Data - Inputs not pre-filled
        const payment = ref({ amount: '', vs: '', msg: '' });
        const newProfile = ref({ name: '', recipientName: '', iban: '' });

        // INIT
        onMounted(() => {
            const stored = localStorage.getItem('payment_profiles_v2');
            if (stored) profiles.value = JSON.parse(stored);
            if (profiles.value.length > 0) activeProfileName.value = profiles.value[0].name;
            
            setupCarouselObserver();
        });

        const closeQr = () => {
            isQrVisible.value = false;
        };

        // --- CAROUSEL & QR ---
        const setupCarouselObserver = () => {
             if (!carouselRef.value) return;
             const observer = new IntersectionObserver((entries) => {
                 entries.forEach(entry => {
                     if (entry.isIntersecting) {
                         const name = entry.target.getAttribute('data-profile');
                         activeProfileName.value = name || '';
                     }
                 });
             }, { root: carouselRef.value, threshold: 0.6 });
             Array.from(carouselRef.value.children).forEach(child => observer.observe(child));
        };
        
        watch(() => profiles.value.length, () => nextTick(setupCarouselObserver));

        const generateVariableSymbol = () => payment.value.vs = String(Date.now()).slice(-10);

        const saveProfile = () => {
            const { name, recipientName, iban } = newProfile.value;
            if(!name || !recipientName || !iban) return alert("Vyplňte všetky údaje");
            profiles.value.push({ ...newProfile.value });
            localStorage.setItem('payment_profiles_v2', JSON.stringify(profiles.value));
            isAddingProfile.value = false;
            newProfile.value = { name: '', recipientName: '', iban: '' };
            nextTick(() => {
                const el = carouselRef.value.children[profiles.value.length - 1]; 
                if(el) el.scrollIntoView({ behavior: 'smooth', inline: 'center' });
            });
        };

        const deleteProfile = (name) => {
            if(!confirm("Zmazať účet?")) return;
            profiles.value = profiles.value.filter(p => p.name !== name);
            localStorage.setItem('payment_profiles_v2', JSON.stringify(profiles.value));
            activeProfileName.value = profiles.value.length > 0 ? profiles.value[0].name : '';
        };

        const getActiveProfileData = () => profiles.value.find(p => p.name === activeProfileName.value);

        const generateQRCode = async () => {
          if(!activeProfileName.value) return alert("Vyberte alebo vytvorte účet");
          if(!payment.value.amount) return alert("Zadajte sumu");
          
          isQrVisible.value = true;

          await nextTick();
          if (!qrcodeContainer.value) return;
          
          qrcodeContainer.value.innerHTML = '';
          const profile = getActiveProfileData();
          
          try {
            const paymentData = {
              type: 1, amount: Number(payment.value.amount), currencyCode: "EUR",
              variableSymbol: payment.value.vs ? payment.value.vs.trim() : undefined, 
              paymentNote: payment.value.msg ? payment.value.msg.trim() : undefined,
              beneficiaryName: profile.recipientName.trim(), bankAccounts: [{ iban: profile.iban.trim() }],
            };
            // Clean undefined
            if (!paymentData.variableSymbol) delete paymentData.variableSymbol;
            if (!paymentData.paymentNote) delete paymentData.paymentNote;

            const qrData = window.bysquare.encode({ payments: [paymentData] });
            new QRCode(qrcodeContainer.value, { text: qrData, width: 140, height: 140, colorDark: "#1e293b", colorLight: "#ffffff", correctLevel: QRCode.CorrectLevel.L });
          } catch (e) { console.error(e); }
        };

        const copyPaymeLink = async () => {
            const profile = getActiveProfileData();
            if(!profile) return;
            const params = new URLSearchParams({ V: '1', IBAN: profile.iban.replace(/\s/g, ''), AM: Number(payment.value.amount).toFixed(2), CC: 'EUR' });
            if(payment.value.vs) params.append('PI', '/VS'+payment.value.vs);
            if(profile.recipientName) params.append('CN', profile.recipientName);
            const url = `https://payme.sk?${params.toString()}`;
            try { await navigator.clipboard.writeText(url); paymeLinkCopied.value = true; setTimeout(() => paymeLinkCopied.value = false, 2000); } catch(e) { alert(url); }
        };

        watch(payment, () => {
            if(isQrVisible.value) {
                if(window.t) clearTimeout(window.t);
                window.t = setTimeout(generateQRCode, 300);
            }
        }, { deep: true });

        return {
          carouselRef, qrcodeContainer,
          isAddingProfile, isQrVisible, paymeLinkCopied,
          payment, newProfile, profiles, activeProfileName,
          saveProfile, deleteProfile, generateVariableSymbol, generateQRCode, copyPaymeLink,
          closeQr
        };
      }
    }).mount('#app');
  </script>
</body>
</html>
